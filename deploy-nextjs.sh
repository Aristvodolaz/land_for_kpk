#!/bin/bash

# ================================
# DEPLOY SCRIPT FOR NEXT.JS
# ================================

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï)
SERVER_USER="username"
SERVER_HOST="your-server.com"
SERVER_PATH="/var/www/landing"
SERVER_NGINX_RELOAD="yes" # yes –∏–ª–∏ no

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞
success() {
    echo -e "${GREEN}‚úì $1${NC}"
}

error() {
    echo -e "${RED}‚úó $1${NC}"
    exit 1
}

info() {
    echo -e "${BLUE}‚Ñπ $1${NC}"
}

warning() {
    echo -e "${YELLOW}‚ö† $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    error "–§–∞–π–ª package.json –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ Next.js."
fi

if [ ! -f "next.config.js" ]; then
    error "–§–∞–π–ª next.config.js –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —ç—Ç–æ Next.js –ø—Ä–æ–µ–∫—Ç."
fi

echo ""
info "========================================"
info "  –î–ï–ü–õ–û–ô NEXT.JS –ù–ê –í–ê–® –°–ï–†–í–ï–†"
info "========================================"
echo ""

# –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
info "–®–∞–≥ 1/5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º..."
if ssh -o ConnectTimeout=5 -o BatchMode=yes "$SERVER_USER@$SERVER_HOST" exit 2>/dev/null; then
    success "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
else
    error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É $SERVER_USER@$SERVER_HOST"
fi

# –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
info "–®–∞–≥ 2/5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if [ ! -d "node_modules" ]; then
    warning "node_modules –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º npm install..."
    npm install || error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
fi

# –®–∞–≥ 3: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
info "–®–∞–≥ 3/5: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Next.js..."
rm -rf .next out
npm run build || error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø—Ä–æ–µ–∫—Ç–∞"
success "–ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ /out —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "out" ]; then
    error "–ü–∞–ø–∫–∞ /out –Ω–µ —Å–æ–∑–¥–∞–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ next.config.js (output: 'export')"
fi

# –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
info "–®–∞–≥ 4/5: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
BACKUP_DIR="$SERVER_PATH.backup.$(date +%Y%m%d_%H%M%S)"
ssh "$SERVER_USER@$SERVER_HOST" "
    if [ -d '$SERVER_PATH' ]; then
        cp -r '$SERVER_PATH' '$BACKUP_DIR'
        echo '–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_DIR'
    else
        echo '–ü–∞–ø–∫–∞ $SERVER_PATH –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±—ç–∫–∞–ø –Ω–µ –Ω—É–∂–µ–Ω'
    fi
" || warning "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø (–≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –ø–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π)"
success "–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω (–µ—Å–ª–∏ –±—ã–ª –∫–æ–Ω—Ç–µ–Ω—Ç)"

# –®–∞–≥ 5: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
info "–®–∞–≥ 5/5: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
rsync -avz --delete \
    --exclude='node_modules' \
    --exclude='.git' \
    --exclude='.next' \
    out/ "$SERVER_USER@$SERVER_HOST:$SERVER_PATH/" || error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤"
success "–§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–∞–≤
info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
ssh "$SERVER_USER@$SERVER_HOST" "
    chown -R www-data:www-data '$SERVER_PATH' 2>/dev/null || echo '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ (—Ç—Ä–µ–±—É—é—Ç—Å—è root –ø—Ä–∞–≤–∞)'
    chmod -R 755 '$SERVER_PATH'
" || warning "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é —Å sudo)"
success "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
if [ "$SERVER_NGINX_RELOAD" = "yes" ]; then
    info "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
    ssh "$SERVER_USER@$SERVER_HOST" "
        sudo nginx -t && sudo systemctl reload nginx
    " 2>/dev/null && success "Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω" || warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Nginx (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é)"
fi

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
info "–û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏..."
rm -rf .next
success "–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"

echo ""
success "========================================"
success "  –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–Å–ù –£–°–ü–ï–®–ù–û! üéâ"
success "========================================"
echo ""
info "–í–∞—à —Å–∞–π—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞: http://$SERVER_HOST"
info "–ü—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: $SERVER_PATH"
echo ""
warning "–ù–µ –∑–∞–±—É–¥—å—Ç–µ:"
warning "  1. –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl + Shift + R)"
warning "  2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
warning "  3. –ó–∞–º–µ–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ Telegram –∫–∞–Ω–∞–ª"
echo ""
